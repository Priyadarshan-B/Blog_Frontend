@page "/login"
@using System.Text.Json.Serialization

@inject HttpClient Http
@inject IJSRuntime JS
@inject NavigationManager Navigation


<h3>Login with Google</h3>

<div id="googleSignInBtn"></div>

@code {
    private DotNetObjectReference<Login>? objRef;
    private const string ApiHost = "http://localhost:5000";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("googleLogin.initialize",
            "598155518602-f5ci4vkj1i84siubr7ad3gd4fn00sonh.apps.googleusercontent.com", objRef);
        }
    }

    [JSInvokable("OnGoogleLogin")]
    public async Task OnGoogleLogin(string idToken)
    {
        var reqpayload = new { IdToken = idToken };
        var response = await Http.PostAsJsonAsync($"{ApiHost}/api/auth/google", reqpayload);

        if (response.IsSuccessStatusCode)
        {
            var user = await response.Content.ReadFromJsonAsync<UserResponse>();

            if (user != null && !string.IsNullOrEmpty(user.JwtToken))
            {
                await JS.InvokeVoidAsync("localStorage.setItem", "D!", user.JwtToken);
                Navigation.NavigateTo("/post");
            }
        }
        else
        {
            Console.Error.WriteLine("Google sign-in failed: " + await response.Content.ReadAsStringAsync());
        }
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }

    public class UserResponse
    {
         [JsonPropertyName("token")]
        public string? JwtToken { get; set; }
    }
}
